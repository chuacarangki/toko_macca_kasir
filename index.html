<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesehan Lamacca - Toko Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary-blue: #004aad; --primary-deep: #002d62; --soft-bg: #f8fafd; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--soft-bg); padding-bottom: 90px; margin: 0; overflow-x: hidden; }

        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,45,98,0.9), rgba(0,74,173,0.8)), 
                        url('https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=800&q=80');
            background-size: cover; background-position: center;
            z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .glass-card { background: #fff; border-radius: 30px; width: 100%; max-width: 400px; padding: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); }

        .header-lux {
            background: linear-gradient(135deg, var(--primary-deep) 0%, var(--primary-blue) 100%);
            padding: 25px 20px 70px; border-radius: 0 0 40px 40px; color: white; position: relative;
        }
        .search-box {
            position: absolute; bottom: -22px; left: 20px; right: 20px;
            background: white; border-radius: 15px; padding: 10px 15px;
            display: flex; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .search-box input { border: none; width: 100%; margin-left: 10px; outline: none; font-size: 14px; }

        .promo-scroll, .best-seller-wrapper, .category-wrapper { overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        .promo-scroll::-webkit-scrollbar, .best-seller-wrapper::-webkit-scrollbar, .category-wrapper::-webkit-scrollbar { display: none; }
        
        .promo-card { display: inline-block; width: 280px; height: 120px; margin-right: 15px; border-radius: 20px; padding: 20px; color: white; position: relative; overflow: hidden; }
        .promo-1 { background: linear-gradient(45deg, #ff9100, #ffbd59); }
        .promo-2 { background: linear-gradient(45deg, #00b4db, #0083b0); }

        .best-card { display: inline-block; width: 140px; margin-right: 12px; background: white; border-radius: 18px; padding: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; cursor: pointer; }
        .best-card img { width: 100%; height: 100px; object-fit: cover; border-radius: 12px; margin-bottom: 8px; }

        .cat-pill { display: inline-block; padding: 10px 22px; border-radius: 15px; background: white; margin-right: 10px; font-size: 13px; font-weight: 700; color: #666; border: none; }
        .cat-pill.active { background: var(--primary-blue); color: white; }

        .menu-card { background: white; border-radius: 22px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: none; height: 100%; position: relative; cursor: pointer; transition: 0.3s; }
        .menu-card:active { transform: scale(0.95); }
        .menu-img-container { position: relative; width: 100%; height: 130px; }
        .menu-img { height: 100%; width: 100%; object-fit: cover; }
        .is-habis .menu-img { filter: grayscale(1) brightness(0.6); }
        .habis-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.3); }
        .is-habis .habis-overlay { display: flex; }
        .price-tag { position: absolute; bottom: 8px; right: 8px; background: rgba(255,255,255,0.9); padding: 3px 10px; border-radius: 8px; font-weight: 800; color: var(--primary-blue); font-size: 11px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); z-index: 999; border-radius: 25px 25px 0 0; }
        .nav-item-btn { text-align: center; color: #a0aec0; border: none; background: none; flex: 1; font-size: 11px; font-weight: 600; outline: none; }
        .nav-item-btn.active { color: var(--primary-blue); }
        .nav-item-btn i { font-size: 22px; margin-bottom: 4px; display: block; }

        .cart-bar { position: fixed; bottom: 90px; left: 20px; right: 20px; background: var(--primary-deep); color: white; padding: 15px 25px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 998; display: none; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .whatsapp-float { position: fixed; bottom: 160px; right: 20px; width: 55px; height: 55px; background: #25d366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 997; text-decoration: none; }
        .pay-info-box { background: #fff3cd; border: 1px dashed #ffc107; border-radius: 15px; padding: 12px; margin-top: 10px; font-size: 13px; }
        #map { height: 200px; width: 100%; border-radius: 15px; margin-bottom: 15px; border: 1px solid #ddd; z-index: 1; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="glass-card animate__animated animate__zoomIn">
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-4 d-inline-block p-3 mb-3"><i class="fas fa-store fa-2x"></i></div>
                <h4 class="fw-bold">LESEHAN MACCA</h4>
                <p class="animate__animated animate__fadeInUp animate__delay-1s" 
   style="font-size: 14px; color: #004aad; font-weight: 600; font-style: italic; margin-top: -5px; margin-bottom: 20px;">
   "Citarasa Autentik, Pesan Mudah dari Mana Saja"
</p>
            </div>
            <div class="mb-3">
                <label class="small fw-bold text-muted">Nama Lengkap</label>
                <input type="text" id="waNama" class="form-control rounded-pill px-3" placeholder="Contoh: Lesehan Macca">
            </div>
            <div class="mb-4">
                <label class="small fw-bold text-muted">Nomor WhatsApp</label>
                <input type="number" id="waNomor" class="form-control rounded-pill px-3" placeholder="Contoh: 08123456789">
            </div>
            <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" onclick="handleWaLogin()">MULAI PESAN</button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div id="view-home">
            <div class="header-lux">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0 opacity-75 small">Lokasi Anda</p>
                        <h6 class="fw-bold"><i class="fas fa-map-marker-alt text-warning me-1"></i> Makassar, Indonesia</h6>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-circle p-2"><i class="fas fa-bell"></i></div>
                </div>
                <h4 class="mt-4 fw-bold">Halo, <span id="userDisplay">Pelanggan</span>!</h4>
                <div class="search-box">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" placeholder="Cari menu favorit..." onkeyup="searchMenu(this.value)">
                </div>
            </div>

            <div style="margin-top: 40px;">
                <div class="promo-scroll px-3">
                    <div class="promo-card promo-1">
                        <h6 class="fw-bold mb-1">Diskon 20%</h6>
                        <p class="small mb-0">Khusus pengguna baru!</p>
                        <i class="fas fa-percentage position-absolute opacity-25" style="font-size: 80px; bottom: -10px; right: -10px;"></i>
                    </div>
                    <div class="promo-card promo-2">
                        <h6 class="fw-bold mb-1">Gratis Ongkir</h6>
                        <p class="small mb-0">Min. belanja Rp 50rb</p>
                        <i class="fas fa-motorcycle position-absolute opacity-25" style="font-size: 80px; bottom: -10px; right: -10px;"></i>
                    </div>
                </div>

                <div class="px-3 mt-4"><h6 class="fw-bold"><i class="fas fa-fire text-danger me-1"></i> Terlaris</h6></div>
                <div class="best-seller-wrapper px-3" id="bestSellerGrid"></div>

                <div class="px-3 mt-4"><h6 class="fw-bold">Kategori</h6></div>
                <div class="category-wrapper px-3 mb-2" id="catList"></div>

                <div class="container">
                    <div class="row g-3" id="menuGrid"></div>
                </div>
            </div>
        </div>

        <div id="view-orders" style="display: none;">
            <div class="p-3 bg-white border-bottom text-center"><h5 class="fw-bold mb-0">Pesanan Saya</h5></div>
            <div class="container mt-3" id="orderHistoryList"></div>
        </div>

        <div id="view-profile" style="display: none;">
            <div class="p-4 text-center bg-white border-bottom">
                <div class="position-relative d-inline-block">
                    <img src="" id="profImg" class="rounded-circle border shadow-sm" style="width:100px; height:100px; object-fit:cover;">
                    <label for="imgInp" class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 border border-white" style="cursor:pointer;"><i class="fas fa-camera fa-xs"></i></label>
                    <input type="file" id="imgInp" hidden onchange="uploadAvatar(this)">
                </div>
                <h5 class="fw-bold mt-3 mb-0" id="profNama">Nama</h5>
                <p class="text-muted small" id="profEmail">WhatsApp User</p>
            </div>
            <div class="container mt-3">
                <div class="card p-3 border-0 rounded-4 shadow-sm">
                    <label class="small fw-bold text-muted">Nomor WA</label>
                    <input type="number" id="upWA" class="form-control border-0 bg-light mb-3" readonly>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="small fw-bold text-muted mb-0">Titik Lokasi (Maps)</label>
                        <button class="btn btn-sm btn-outline-primary py-0" onclick="getLocation()" style="font-size: 10px;">GPS SAYA</button>
                    </div>
                    <div id="map"></div>
                    <input type="hidden" id="upLat">
                    <input type="hidden" id="upLng">

                    <label class="small fw-bold text-muted">Alamat Lengkap / Patokan</label>
                    <textarea id="upAlamat" class="form-control border-0 bg-light mb-3" rows="3" placeholder="Nama Jalan, Blok, atau Patokan Rumah"></textarea>
                    
                    <button class="btn btn-primary w-100 rounded-pill fw-bold" onclick="saveProfile()">Simpan Profil</button>
                    <button class="btn btn-link text-danger w-100 mt-2" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </div>

        <a href="https://wa.me/6282191262682" class="whatsapp-float animate__animated animate__bounceIn" target="_blank"><i class="fab fa-whatsapp"></i></a>

        <div class="cart-bar animate__animated animate__fadeInUp" id="cartBar" onclick="processCheckout()">
            <div class="d-flex align-items-center"><div class="bg-white text-primary rounded-pill px-3 fw-bold me-2" id="cartQty">0</div><span class="small fw-bold">Checkout Pesanan</span></div>
            <div id="cartTotal" class="fw-bold">Rp 0</div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item-btn active" id="btn-home" onclick="switchView('home')"><i class="fas fa-home"></i> Beranda</button>
            <button class="nav-item-btn" id="btn-orders" onclick="switchView('orders')"><i class="fas fa-receipt"></i> Pesanan</button>
            <button class="nav-item-btn" id="btn-profile" onclick="switchView('profile')"><i class="fas fa-user-circle"></i> Profil</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWz63o_JFK3Ucvb7IuXI1cNO8SXMHvsEA",
            authDomain: "kasirmaccanew.firebaseapp.com",
            databaseURL: "https://kasirmaccanew-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kasirmaccanew"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const TOKO_LAT = -5.2039023; 
        const TOKO_LNG = 119.5002886;
        const TARIF_PER_KM = 2000;    
        const MIN_ONGKIR = 5000;      
        const MIN_BELANJA_FREE = 50000;

        let userData = null;
        let masterMenu = [];
        let cart = [];
        let map, marker;

        // --- FUNGSI GLOBAL ---
        function hitungJarak(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        window.handleWaLogin = async () => {
            const nama = document.getElementById('waNama').value;
            const wa = document.getElementById('waNomor').value;
            if(!nama || !wa) return Swal.fire('Error', 'Nama dan WA harus diisi', 'error');

            const userId = 'user_' + wa;
            const userRef = ref(db, `users/${userId}`);
            const snap = await get(userRef);
            
            if(snap.exists()) {
                userData = snap.val();
            } else {
                userData = { uid: userId, nama, wa, alamat: '', lat: -5.1476, lng: 119.4327, avatar: '' };
                await set(userRef, userData);
            }
            localStorage.setItem('user_lamacca', JSON.stringify(userData));
            checkAuth();
        };

        window.handleLogout = () => {
            localStorage.removeItem('user_lamacca');
            location.reload();
        };

        window.initMap = (lat, lng) => {
            if (map) {
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
                return;
            }
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);
            marker.on('dragend', () => {
                const pos = marker.getLatLng();
                document.getElementById('upLat').value = pos.lat;
                document.getElementById('upLng').value = pos.lng;
            });
        };

        window.getLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    const lat = p.coords.latitude, lng = p.coords.longitude;
                    window.initMap(lat, lng);
                    document.getElementById('upLat').value = lat;
                    document.getElementById('upLng').value = lng;
                }, () => Swal.fire('Info', 'Aktifkan GPS Anda', 'info'));
            }
        };

        window.switchView = (view) => {
            ['home', 'orders', 'profile'].forEach(v => {
                const el = document.getElementById('view-'+v);
                if(el) el.style.display = v === view ? 'block' : 'none';
            });
            document.querySelectorAll('.nav-item-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-' + view);
            if(btn) btn.classList.add('active');
            if(view === 'orders') loadOrderHistory();
            if(view === 'profile') loadProfile();
        };

        window.addToCart = (id) => {
            const item = masterMenu.find(m => m.id === id);
            if(!item || item.status === 'Habis') return;
            const inCart = cart.find(c => c.id === id);
            inCart ? inCart.qty++ : cart.push({...item, qty: 1});
            updateCartUI();
        };

        window.saveProfile = () => {
            const up = { 
                alamat: document.getElementById('upAlamat').value,
                lat: parseFloat(document.getElementById('upLat').value), 
                lng: parseFloat(document.getElementById('upLng').value)
            };
            update(ref(db, `users/${userData.uid}`), up).then(() => {
                Swal.fire('Sukses', 'Profil Diupdate', 'success');
                userData = {...userData, ...up};
                localStorage.setItem('user_lamacca', JSON.stringify(userData));
            });
        };

        window.uploadAvatar = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => update(ref(db, `users/${userData.uid}`), { avatar: e.target.result }).then(() => { document.getElementById('profImg').src = e.target.result; });
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.searchMenu = (val) => {
            const filtered = masterMenu.filter(m => m.name.toLowerCase().includes(val.toLowerCase()));
            renderMenuByData(filtered);
        };

        window.renderMenu = (cat, el) => {
            if(el) { document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active')); el.classList.add('active'); }
            const filtered = cat === 'Semua' ? masterMenu : masterMenu.filter(m => m.category === cat);
            renderMenuByData(filtered);
        };

        window.toggleOngkir = (isAntar, ongkir, belanja) => {
            const row = document.getElementById('row-ongkir');
            if(row) row.style.opacity = isAntar ? '1' : '0.3';
            const totalDisplay = document.getElementById('text-total');
            if(totalDisplay) totalDisplay.innerText = 'Rp ' + (belanja + (isAntar ? ongkir : 0)).toLocaleString();
        };

        window.updatePayInfo = (t) => {
            const b = document.getElementById('pay-info-box');
            if(!b) return;
            if(t==='COD') {
                b.innerHTML = '<div class="animate__animated animate__fadeIn"><i class="fas fa-hand-holding-usd me-1 text-success"></i> Bayar tunai saat pesanan tiba.</div>';
            } else if(t==='BANK') {
                b.innerHTML = '<div class="animate__animated animate__fadeIn"><i class="fas fa-university me-1 text-primary"></i> BRI: 0403 0101 2546 539 <br>A/N SULKIFLI</div>';
            } else if(t==='QRIS') {
                b.innerHTML = `
                    <div class="animate__animated animate__fadeIn text-center mt-2">
                        <p class="mb-2 fw-bold" style="font-size:12px;">Scan QRIS Lesehan Lamacca:</p>
                        <img src="https://chuacarangki.github.io/toko_macca_kasir/qrismacca.jpeg" 
                             class="img-fluid rounded border shadow-sm p-2 bg-white" 
                             style="width: 180px; height: auto;">
                        <p class="mt-2 mb-0 fw-bold text-danger" style="font-size:10px;">
                            <i class="fas fa-info-circle"></i> Screenshot & kirim bukti ke WA
                        </p>
                    </div>`;
            }
        };

        // --- INTERNAL FUNCTIONS ---
        function checkAuth() {
            const savedUser = localStorage.getItem('user_lamacca');
            if(savedUser) {
                userData = JSON.parse(savedUser);
                document.getElementById('userDisplay').innerText = userData.nama;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadMenuData();
                listenToOrderStatus(); // AKTIFKAN NOTIFIKASI
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        }

        function loadMenuData() {
            onValue(ref(db, 'master_menu'), (snap) => {
                masterMenu = [];
                if(snap.exists()) {
                    Object.keys(snap.val()).forEach(k => masterMenu.push({id: k, ...snap.val()[k]}));
                    renderBestSeller(); renderCategories(); window.renderMenu('Semua');
                }
            });
        }

        async function loadProfile() {
            const snap = await get(ref(db, `users/${userData.uid}`));
            const u = snap.val();
            document.getElementById('profNama').innerText = u.nama;
            document.getElementById('profImg').src = u.avatar || `https://ui-avatars.com/api/?name=${u.nama}&background=004aad&color=fff`;
            document.getElementById('upWA').value = u.wa;
            document.getElementById('upAlamat').value = u.alamat || '';
            const lt = u.lat || -5.1476, lg = u.lng || 119.4327;
            document.getElementById('upLat').value = lt;
            document.getElementById('upLng').value = lg;
            setTimeout(() => { window.initMap(lt, lg); map.invalidateSize(); }, 500);
        }

        function updateCartUI() {
            const bar = document.getElementById('cartBar');
            if(cart.length > 0) {
                bar.style.display = 'flex';
                document.getElementById('cartQty').innerText = cart.reduce((a,b) => a + b.qty, 0);
                document.getElementById('cartTotal').innerText = 'Rp ' + cart.reduce((a,b) => a + (b.qty * b.price), 0).toLocaleString();
            } else bar.style.display = 'none';
        }

        function renderBestSeller() {
            const best = masterMenu.filter(m => m.status !== 'Habis').slice(0, 6);
            document.getElementById('bestSellerGrid').innerHTML = best.map(m => `
                <div class="best-card" onclick="addToCart('${m.id}')">
                    <img src="${m.image || 'https://via.placeholder.com/150'}">
                    <div class="small fw-bold text-truncate">${m.name}</div>
                    <div class="text-primary fw-bold" style="font-size:11px;">Rp ${parseInt(m.price).toLocaleString()}</div>
                </div>`).join('');
        }

        function renderCategories() {
            const cats = ['Semua', ...new Set(masterMenu.map(m => m.category))];
            document.getElementById('catList').innerHTML = cats.map(c => `<button class="cat-pill ${c==='Semua'?'active':''}" onclick="renderMenu('${c}', this)">${c}</button>`).join('');
        }

        function renderMenuByData(data) {
            document.getElementById('menuGrid').innerHTML = data.map(m => {
                const isHabis = m.status === 'Habis';
                return `<div class="col-6">
                    <div class="menu-card ${isHabis ? 'is-habis' : ''}" onclick="${isHabis ? '' : `addToCart('${m.id}')`}">
                        <div class="menu-img-container">
                            <img src="${m.image || 'https://via.placeholder.com/150'}" class="menu-img">
                            <div class="habis-overlay"><span class="badge bg-danger">HABIS</span></div>
                            <div class="price-tag">Rp ${parseInt(m.price).toLocaleString()}</div>
                        </div>
                        <div class="p-3 text-center">
                            <div class="fw-bold small text-truncate mb-2">${m.name}</div>
                            <button class="btn btn-primary btn-sm w-100 rounded-pill fw-bold" ${isHabis ? 'disabled' : ''}>${isHabis ? 'HABIS' : 'TAMBAH'}</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function loadOrderHistory() {
            onValue(ref(db, 'pesanan_masuk'), (snap) => {
                const list = document.getElementById('orderHistoryList'); list.innerHTML = '';
                if(snap.exists()) {
                    const myOrders = Object.keys(snap.val()).map(k => ({id:k, ...snap.val()[k]})).filter(o => o.uid === userData.uid).sort((a,b) => b.timestamp - a.timestamp);
                    myOrders.forEach(o => {
                        list.innerHTML += `<div class="card p-3 border-0 rounded-4 shadow-sm mb-3 animate__animated animate__fadeIn">
                            <div class="d-flex justify-content-between small"><span class="text-muted">${o.waktu}</span><span class="badge bg-primary">${o.status}</span></div>
                            <div class="fw-bold mt-2">${o.items.map(i => i.name+' x'+i.qty).join(', ')}</div>
                            <div class="text-primary fw-bold">Rp ${o.total_bayar.toLocaleString()}</div>
                        </div>`;
                    });
                }
            });
        }

        // --- PROSES CHECKOUT ---
        window.processCheckout = async () => {
            const uSnap = await get(ref(db, `users/${userData.uid}`));
            const profile = uSnap.val();

            if (!profile.lat || !profile.lng || !profile.alamat) {
                return Swal.fire({
                    title: 'Lengkapi Profil',
                    text: 'Silakan isi Alamat & Titik Lokasi di menu Profil agar kami bisa menghitung ongkir.',
                    icon: 'warning',
                    confirmButtonText: 'Ke Profil',
                    confirmButtonColor: '#004aad'
                }).then(() => switchView('profile'));
            }

            const totalBelanja = cart.reduce((a,b) => a + (b.qty * b.price), 0);
            const jarakKM = hitungJarak(TOKO_LAT, TOKO_LNG, profile.lat, profile.lng);
            
            // --- Logika Baru Disisipkan Di Sini ---
            let ongkirNormal = 0;
            if (jarakKM <= 1) {
                ongkirNormal = 5000;
            } else {
                const jarakMeter = jarakKM * 1000;
                const hitungKasar = jarakMeter * 5;
                // Membulatkan ke atas ke kelipatan 1000 terdekat
                ongkirNormal = Math.ceil(hitungKasar / 1000) * 1000;
            }
            // --- Akhir Logika Baru ---

            const isFree = totalBelanja >= MIN_BELANJA_FREE;
            const ongkirFinal = isFree ? 0 : ongkirNormal;

            const itemsHtml = cart.map(i => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-start">
                        <div class="fw-bold" style="font-size: 14px;">${i.name}</div>
                        <div class="text-muted" style="font-size: 12px;">${i.qty} x Rp ${i.price.toLocaleString()}</div>
                    </div>
                    <div class="fw-bold text-dark">Rp ${(i.qty*i.price).toLocaleString()}</div>
                </div>`).join('');

            const { value: res } = await Swal.fire({
                title: '<span style="font-size: 18px; font-weight: 800;">Konfirmasi Pesanan</span>',
                html: `
                    <div class="text-start p-1">
                        <div class="mb-3 p-3 rounded-4 bg-light border-0">
                            <div class="small fw-bold text-muted mb-2 text-uppercase" style="letter-spacing: 1px;">Item Pesanan</div>
                            ${itemsHtml}
                        </div>

                        <div class="mb-3">
                            <div class="small fw-bold text-muted mb-2 text-uppercase">Metode Pengiriman</div>
                            <div class="btn-group w-100 shadow-sm rounded-pill overflow-hidden" style="border: 1px solid #eee;">
                                <input type="radio" class="btn-check" name="tipe" id="t1" value="Antar" checked onclick="toggleOngkir(true, ${ongkirFinal}, ${totalBelanja})">
                                <label class="btn btn-outline-primary border-0 py-2 fw-bold" for="t1"><i class="fas fa-motorcycle me-2"></i>ANTAR</label>
                                
                                <input type="radio" class="btn-check" name="tipe" id="t2" value="Jemput" onclick="toggleOngkir(false, 0, ${totalBelanja})">
                                <label class="btn btn-outline-primary border-0 py-2 fw-bold" for="t2"><i class="fas fa-walking me-2"></i>AMBIL</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="small fw-bold text-muted mb-2 text-uppercase">Metode Pembayaran</div>
                            <div class="btn-group w-100 shadow-sm rounded-pill overflow-hidden" style="border: 1px solid #eee; font-size: 11px;">
                                <input type="radio" class="btn-check" name="bayar" id="b1" value="COD" checked onclick="updatePayInfo('COD')">
                                <label class="btn btn-outline-success border-0 py-2 fw-bold" for="b1">COD</label>
                                
                                <input type="radio" class="btn-check" name="bayar" id="b2" value="Bank" onclick="updatePayInfo('BANK')">
                                <label class="btn btn-outline-success border-0 py-2 fw-bold" for="b2">TRANSFER</label>

                                <input type="radio" class="btn-check" name="bayar" id="b3" value="QRIS" onclick="updatePayInfo('QRIS')">
                                <label class="btn btn-outline-success border-0 py-2 fw-bold" for="b3">QRIS</label>
                            </div>
                            <div id="pay-info-box" class="pay-info-box mt-2 text-center" style="font-size: 12px; min-height: 40px;">
                                Bayar tunai saat pesanan tiba.
                            </div>
                        </div>

                        <div class="card border-0 rounded-4 bg-primary text-white p-3 shadow-lg">
                            <div class="d-flex justify-content-between small opacity-75"><span>Subtotal</span><span>Rp ${totalBelanja.toLocaleString()}</span></div>
                            <div class="d-flex justify-content-between small opacity-75" id="row-ongkir">
                                <span>Ongkir (${jarakKM.toFixed(1)} km)</span>
                                <span id="val-ongkir">${isFree ? 'GRATIS' : 'Rp '+ongkirNormal.toLocaleString()}</span>
                            </div>
                            <hr class="my-2 opacity-25">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">TOTAL BAYAR</span>
                                <span id="text-total" style="font-size: 20px; font-weight: 800;">Rp ${(totalBelanja + ongkirFinal).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                cancelButtonText: 'Batal',
                confirmButtonText: 'Kirim Pesanan',
                confirmButtonColor: '#004aad',
                preConfirm: () => ({ 
                    tipe: document.querySelector('input[name="tipe"]:checked').value, 
                    bayar: document.querySelector('input[name="bayar"]:checked').value,
                    ongkir: document.querySelector('input[name="tipe"]:checked').value === 'Antar' ? ongkirFinal : 0
                })
            });

            if(res) {
                const order = { 
                    uid: userData.uid, pelanggan: profile.nama, telepon: profile.wa, alamat: profile.alamat, 
                    lat: profile.lat, lng: profile.lng, items: cart, total_belanja: totalBelanja,
                    ongkir: res.ongkir, total_bayar: totalBelanja + res.ongkir, 
                    tipe: res.tipe, metode_bayar: res.bayar, status: 'Pending', 
                    waktu: new Date().toLocaleString('id-ID'), timestamp: Date.now() 
                };
                
                push(ref(db, 'pesanan_masuk'), order).then(() => { 
                    if (order.metode_bayar === 'COD') {
                        Swal.fire({ title: 'Berhasil!', text: 'Pesanan COD Anda telah tersimpan.', icon: 'success', confirmButtonColor: '#004aad' });
                    } else {
                        Swal.fire({ 
                            title: 'Pesanan Tersimpan!', 
                            text: 'Silakan klik tombol di bawah untuk kirim bukti bayar ke WA.', 
                            icon: 'info', 
                            showCancelButton: true,
                            confirmButtonText: '<i class="fab fa-whatsapp me-2"></i>Kirim Bukti Bayar',
                            confirmButtonColor: '#25d366'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                let pesanChat = `Halo Admin Lesehan Lamacca, saya ingin kirim bukti bayar untuk pesanan saya (Metode: ${order.metode_bayar}).`;
                                window.open(`https://wa.me/6282191262682?text=${pesanChat}`, '_blank');
                            }
                        });
                    }
                    cart = []; updateCartUI(); switchView('orders');
                });
            }
        };
        // --- NOTIFIKASI STATUS PESANAN ---
        function listenToOrderStatus() {
            if (!userData) return;
            onValue(ref(db, 'pesanan_masuk'), (snap) => {
                if (snap.exists()) {
                    const data = snap.val();
                    const now = Date.now();
                    Object.keys(data).forEach(key => {
                        const order = data[key];
                        if (order.uid === userData.uid && order.status === 'Diterima' && !localStorage.getItem('notif_accept_' + key) && (now - order.timestamp) < 86400000) { 
                            localStorage.setItem('notif_accept_' + key, 'true');
                            
                            // Suara Notifikasi
                            const audio = new Audio('https://github.com/chuacarangki/toko_macca_kasir/raw/refs/heads/main/notif.mp3');
                            audio.play().catch(e => console.log("Sound blocked by browser."));

                            // Visual Notification (Toast)
                            const Toast = Swal.mixin({
                                toast: true, position: 'top-end', showConfirmButton: false, timer: 6000, timerProgressBar: true
                            });
                            Toast.fire({
                                icon: 'success', title: 'Pesanan Diterima! üë®‚Äçüç≥', text: 'Admin sedang memproses pesananmu.'
                            });
                        }
                    });
                    if (order.status === 'Menunggu Driver' && !localStorage.getItem('notif_wait_driver_' + key)) {
    // Notif + suara
    localStorage.setItem('notif_wait_driver_' + key, 'true');
}
// Serupa untuk 'Diantar' dan 'Sukses'
                }
            });
        }

        checkAuth();
    </script>
</body>
</html>
