<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Macca Driver â€¢ Ultra Dynamic</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --bg-dark: #0b0f1a;
            --card-glass: rgba(23, 32, 53, 0.8);
            --accent-blue: #00d2ff;
            --text-main: #f1f5f9;
            --gold-gradient: linear-gradient(135deg, #FFD700, #FFA500);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding-bottom: 110px; 
            background-image: radial-gradient(circle at top right, #16213e, #0b0f1a);
            min-height: 100vh;
        }

        .stats-header {
            padding: 20px; background: rgba(11, 15, 26, 0.9);
            backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 900;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .stat-badge {
            background: var(--gold-gradient);
            color: #000; padding: 6px 15px; border-radius: 12px; font-weight: 800;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .logout-inline {
            background: rgba(255, 71, 87, 0.2); color: #ff4757;
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255, 71, 87, 0.3); cursor: pointer;
        }

        .order-card {
            background: var(--card-glass); border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px;
            overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .card-top { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .cust-name { font-weight: 800; font-size: 1.2rem; color: var(--accent-blue); margin: 0; cursor: pointer; }
        .cust-phone { font-size: 0.85rem; color: #25D366; font-weight: 700; margin-top: 2px; display: block; cursor: pointer; }

        .action-grid {
            display: grid; grid-template-columns: 1fr 1fr 2fr;
            gap: 12px; padding: 15px; background: rgba(0,0,0,0.2);
        }
        .btn-real {
            border: none; border-radius: 20px; padding: 12px 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 6px; font-weight: 700; font-size: 0.65rem; transition: 0.2s;
        }
        .btn-real i { font-size: 1.6rem; }
        .btn-maps { background: #ffffff10; color: #fff; border: 1px solid #4285F4; }
        .btn-wa { background: #ffffff10; color: #fff; border: 1px solid #25D366; }
        
        .btn-ambil { background: var(--gold-gradient); color: #000; font-weight: 800; }
        .btn-dapur { background: #34495e; color: #95a5a6; font-weight: 700; grid-column: span 2; pointer-events: none; }
        .btn-done { background: #25D366; color: #fff; font-weight: 800; }
        .btn-cancel { background: #ff4757; color: #fff; font-weight: 800; }
        .btn-locked { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); grid-column: span 2; pointer-events: none; }

        .modern-item {
            background: rgba(255,255,255,0.03); border-radius: 22px;
            padding: 15px; margin-bottom: 12px; display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .nav-dock {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(23, 32, 53, 0.98);
            backdrop-filter: blur(25px); border-radius: 40px; padding: 12px;
            display: flex; justify-content: space-around; border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 25px 60px rgba(0,0,0,0.8); z-index: 2000;
        }
        .dock-btn {
            background: none; border: none; color: #576574;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.75rem; font-weight: 800; transition: 0.3s; flex: 1;
        }
        .dock-btn.active { color: var(--accent-blue); }

        .fab-wa-diskon {
            position: fixed; bottom: 110px; right: 20px; z-index: 3000;
            display: flex; align-items: center; justify-content: center;
        }
        .wa-main-btn {
            position: relative; width: 50px; height: 50px; background: #fff; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3); z-index: 10; cursor: pointer;
            animation: pulse-wa 2s infinite;
        }
        @keyframes pulse-wa {
            0% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); }
            100% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0); }
        }
        .wa-main-btn i { color: #25D366; font-size: 28px; }
        .badge-notif {
            position: absolute; top: -5px; right: -5px; background: #ff4757;
            color: white; border-radius: 50%; width: 22px; height: 22px;
            font-size: 11px; font-weight: 800; display: flex; align-items: center;
            justify-content: center; border: 2px solid #fff; z-index: 15;
        }
        .label-admin {
            position: absolute; right: 65px; background: white; color: #333;
            padding: 8px 16px; border-radius: 12px; font-weight: 800; font-size: 11px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: nowrap;
        }

        .motor-pulse {
            font-size: 80px; color: #FFD700;
            animation: pulse-gold 2s infinite; margin-bottom: 20px;
        }
        @keyframes pulse-gold {
            0% { transform: scale(1); filter: drop-shadow(0 0 0px #FFD700); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 20px #FFD700); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0px #FFD700); }
        }

        .date-picker-custom {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 12px; padding: 8px 15px; width: 100%; margin-bottom: 20px;
            outline: none; font-weight: 700;
        }

        .d-none { display: none !important; }
        #login-screen {
            position: fixed; inset: 0; background: var(--bg-dark);
            display: flex; align-items: center; justify-content: center; z-index: 10000;
        }
        .pin-field {
            background: rgba(255,255,255,0.05); border: 2px solid var(--accent-blue);
            color: white; font-size: 3rem; text-align: center; border-radius: 25px;
            width: 100%; margin: 20px 0; font-weight: 800; outline: none;
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="p-10 bg-slate-900/50 backdrop-blur-xl rounded-[40px] border border-white/10 text-center w-[85%] max-w-[380px]">
        <h3 class="font-black text-white text-2xl uppercase">Macca Driver</h3>
        <input type="password" id="driver-pin" class="pin-field" placeholder="â€¢â€¢" maxlength="2">
        <button class="btn btn-info w-100 py-3 rounded-pill fw-800 mt-3" onclick="handleLogin()">MASUK</button>
    </div>
</div>

<div id="main-app" class="d-none">
    <header class="stats-header d-flex justify-content-between align-items-center">
        <div>
            <h6 class="fw-800 mb-0 text-white">MACCA DELIVERY</h6>
            <p class="text-white-50 small mb-0">HUB AKTIF</p>
        </div>
        <div class="header-right">
            <div class="stat-badge">
                <i class="fa-solid fa-crown"></i>
                <span id="driver-name-display">-</span>
            </div>
            <div class="logout-inline" onclick="handleLogout()">
                <i class="fa-solid fa-right-from-bracket"></i>
            </div>
        </div>
    </header>

    <div class="container py-4">
        <div id="tab-delivery" class="tab-content row"></div>
        <div id="tab-ranking" class="tab-content d-none"></div>
        <div id="tab-history" class="tab-content d-none">
            <h5 class="fw-800 mb-2 text-info">LOG PENGANTARAN</h5>
            <input type="date" id="log-date-filter" class="date-picker-custom" onchange="renderWithData()">
            <div id="log-list-container"></div>
        </div>
    </div>

    <div class="fab-wa-diskon" onclick="window.open('https://wa.me/6282191262682', '_blank')">
        <span class="label-admin">CHAT ADMIN</span>
        <div class="wa-main-btn">
            <div class="badge-notif">1</div>
            <i class="fa-brands fa-whatsapp"></i>
        </div>
    </div>

    <div class="nav-dock">
        <button class="dock-btn active" id="btn-tab-delivery" onclick="switchTab('delivery', this)"><i class="fa-solid fa-motorcycle"></i>ANTAR</button>
        <button class="dock-btn" id="btn-tab-ranking" onclick="switchTab('ranking', this)"><i class="fa-solid fa-trophy"></i>RANK</button>
        <button class="dock-btn" id="btn-tab-history" onclick="switchTab('history', this)"><i class="fa-solid fa-clock-rotate-left"></i>LOGS</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWz63o_JFK3Ucvb7IuXI1cNO8SXMHvsEA",
        authDomain: "kasirmaccanew.firebaseapp.com",
        databaseURL: "https://kasirmaccanew-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasirmaccanew"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const DRIVER_DB = { "11": "HASBI", "22": "REZKY", "33": "ASWAR", "66": "SENDY" };

    let currentDriver = "";
    let globalOrders = {};
    let lastOrderCount = 0;
    const notifAudio = new Audio('https://github.com/chuacarangki/toko_macca_kasir/raw/refs/heads/main/notif.mp3');

   // EXPOSE TO WINDOW
window.handleLogin = () => {
    const pin = document.getElementById('driver-pin').value.trim();
    if (DRIVER_DB[pin]) {
        currentDriver = DRIVER_DB[pin];
        localStorage.setItem('macca_driver_logged_in', pin);
        document.getElementById('driver-name-display').innerText = currentDriver;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').classList.remove('d-none');
        
        notifAudio.play().then(() => {
            notifAudio.pause();
            notifAudio.currentTime = 0;
        }).catch(() => {});

        startListening();
    } else {
        Swal.fire({ icon: 'error', title: 'PIN SALAH', background: '#172035', color: '#fff' });
    }
};

window.handleLogout = () => {
    Swal.fire({
        title: 'Keluar?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ya'
    }).then((r) => {
        if (r.isConfirmed) {
            localStorage.removeItem('macca_driver_logged_in');
            location.reload();
        }
    });
};

window.switchTab = (tabName, btn) => {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('d-none'));
    document.getElementById('tab-' + tabName).classList.remove('d-none');
    document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.renderWithData();
};

window.ambilPesanan = (id) => {
    update(ref(db, `pesanan_masuk/${id}`), {
        status: 'Diantar',
        driver_name: currentDriver
    }).then(() => {
        Swal.fire({ icon: 'success', title: 'PESANAN DIAMBIL', timer: 1000, showConfirmButton: false });
    });
};

window.lepasPesanan = (id) => {
    update(ref(db, `pesanan_masuk/${id}`), {
        status: 'Menunggu Driver',
        driver_name: null
    });
};

window.selesaiAntar = (id) => {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

    update(ref(db, `pesanan_masuk/${id}`), {
        status: 'Sukses',
        finish_date: dateStr,
        finish_time: timeStr
    }).then(() => {
        Swal.fire({ icon: 'success', title: 'PENGANTARAN SELESAI', timer: 1500, showConfirmButton: false });
    });
};

window.openWA = (num) => {
    if (!num) return;
    const cleanNum = num.replace(/[^0-9]/g, '');
    const formattedNum = cleanNum.startsWith('0') ? '62' + cleanNum.slice(1) : cleanNum;
    window.open(`https://wa.me/${formattedNum}`, '_blank');
};

window.directMap = (lat, lng) => {
    if (!lat || !lng) {
        Swal.fire('Lokasi tidak tersedia');
        return;
    }
    window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
};

// Fungsi hitung jarak (Haversine) - sederhana tapi cukup akurat
function haversineDistance(lat1, lon1, lat2, lon2) {
    if (!lat1 || !lon1 || !lat2 || !lon2) return 'â€”';
    const R = 6371; // Radius Bumi (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    return distance < 1 ? `${(distance * 1000).toFixed(0)} m` : `${distance.toFixed(1)} km`;
}

// Jarak selalu dihitung dari TITIK TOKO ke pelanggan (bukan dari posisi driver)
let driverLocation = { lat: -5.1476, lng: 119.4327 };

function startListening() {
    onValue(ref(db, 'pesanan_masuk'), (s) => {
        const data = s.val() || {};
        const currentWaitingOrders = Object.values(data).filter(o => o.status === 'Menunggu Driver').length;
        
        if (currentWaitingOrders > lastOrderCount) {
            notifAudio.play().catch(() => {});
        }
        lastOrderCount = currentWaitingOrders;

        globalOrders = data;
        window.renderWithData();
    });
}

window.renderWithData = () => {
    const activeTab = document.getElementById('tab-delivery');
    const rankTab = document.getElementById('tab-ranking');
    const logContainer = document.getElementById('log-list-container');

    // Default hari ini untuk tab LOGS
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('log-date-filter');
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
    const selectedDate = dateInput?.value || today;

    activeTab.innerHTML = '';
    rankTab.innerHTML = '';
    logContainer.innerHTML = '';

    const pointsMap = { "HASBI": 0, "REZKY": 0, "ASWAR": 0, "SENDY": 0 };
    let anyOrder = false;

    // â”€â”€â”€â”€â”€â”€ TAB ANTAR â”€â”€â”€â”€â”€â”€
    Object.keys(globalOrders).forEach(id => {
        const o = globalOrders[id];
        
        if (['Diterima', 'Menunggu Driver', 'Diantar'].includes(o.status)) {
            anyOrder = true;
            const isMine = o.driver_name === currentDriver;
            const isTakenByOther = o.status === 'Diantar' && !isMine;
            const waNumber = o.telepon || o.wa || '';

            // Hitung jarak
            const jarak = haversineDistance(
                driverLocation.lat, driverLocation.lng,
                parseFloat(o.lat), parseFloat(o.lng)
            );

            // Daftar menu + harga
            let menuHtml = '';
            if (o.items?.length) {
                menuHtml = o.items.map(item => {
                    const nama = item.n || item.name || item.nama || 'Menu';
                    const qty = item.qty || 1;
                    const harga = item.p || item.harga || item.price || 0;
                    const subtotal = qty * harga;
                    return `
                        <div class="d-flex justify-content-between small py-1 border-bottom border-secondary border-opacity-25">
                            <span>${qty} Ã— ${nama}</span>
                            <span>Rp ${subtotal.toLocaleString('id-ID')}</span>
                        </div>`;
                }).join('');
            }

            let metodeBadge = '';
            if (o.metode_bayar === 'COD') metodeBadge = '<span class="badge bg-success">COD</span>';
            else if (['Bank', 'Transfer'].includes(o.metode_bayar)) metodeBadge = '<span class="badge bg-primary">TRANSFER</span>';
            else if (o.metode_bayar === 'QRIS') metodeBadge = '<span class="badge bg-info">QRIS</span>';

            activeTab.innerHTML += `
                <div class="col-12 animate__animated animate__fadeInUp">
                    <div class="order-card" style="${isMine ? 'border: 2px solid #00d2ff; background: rgba(0,210,255,0.08);' : ''}">
                        <div class="card-top d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h4 class="cust-name" onclick="openWA('${waNumber}')">${(o.pelanggan || o.name || 'PELANGGAN').toUpperCase()}</h4>
                                <span class="cust-phone" onclick="openWA('${waNumber}')"><i class="fa-brands fa-whatsapp me-1"></i>${waNumber}</span>
                                <p class="small text-white-50 mb-1 mt-2"><i class="fa-solid fa-location-arrow me-1"></i>${o.alamat || 'Alamat Manual'}</p>
                                <p class="small text-warning fw-bold mb-0"><i class="fa-solid fa-route me-1"></i>Jarak: ${jarak}</p>
                            </div>
                            <div class="text-end">
                                <div class="fw-800 text-info fs-5">Rp ${o.total_bayar?.toLocaleString('id-ID')}</div>
                                <div class="mt-1">${metodeBadge}</div>
                                <span class="badge ${isMine ? 'bg-info text-dark' : 'bg-secondary'} mt-1">${o.status === 'Diantar' ? 'PROSES' : o.waktu || 'BARU'}</span>
                            </div>
                        </div>

                        <!-- Daftar menu -->
                        <div class="px-3 pb-2 bg-black bg-opacity-25">
                            ${menuHtml || '<div class="text-center small opacity-50 py-2">Tidak ada detail menu</div>'}
                        </div>

                        <div class="action-grid">
                            <button class="btn-real btn-maps" onclick="directMap('${o.lat}','${o.lng}')">
                                <i class="fa-brands fa-google"></i>MAPS
                            </button>
                            ${o.status === 'Diterima' ? 
                                `<button class="btn-real btn-dapur"><i class="fa-solid fa-fire-burner"></i>PROSES DAPUR</button>` :
                                (isTakenByOther ? 
                                    `<button class="btn-real btn-locked"><i class="fa-solid fa-lock"></i>DIANTAR ${o.driver_name}</button>` : 
                                    (!isMine ? 
                                        `<button class="btn-real btn-ambil" style="grid-column: span 2;" onclick="ambilPesanan('${id}')"><i class="fa-solid fa-motorcycle"></i>AMBIL</button>` : 
                                        `<button class="btn-real btn-cancel" onclick="lepasPesanan('${id}')"><i class="fa-solid fa-xmark"></i>LEPAS</button>
                                         <button class="btn-real btn-done" onclick="selesaiAntar('${id}')"><i class="fa-solid fa-check-double"></i>SELESAI</button>`
                                    )
                                )
                            }
                        </div>
                    </div>
                </div>`;
        }

        if (o.status === 'Sukses' && o.driver_name && pointsMap[o.driver_name] !== undefined) {
            pointsMap[o.driver_name] += 500;
        }
    });

    if (!anyOrder) {
        activeTab.innerHTML = '<div class="text-center p-5 opacity-50"><i class="fa-solid fa-motorcycle motor-pulse"></i><p>Belum ada orderan masuk...</p></div>';
    }

    // â”€â”€â”€â”€â”€â”€ TAB RANKING â”€â”€â”€â”€â”€â”€
    rankTab.innerHTML = '<h5 class="fw-800 mb-4 text-info">DRIVER RANKING</h5>';
    Object.keys(pointsMap).sort((a,b) => pointsMap[b] - pointsMap[a]).forEach((name, i) => {
        const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : i + 1;
        rankTab.innerHTML += `<div class="modern-item"><div class="fw-800 me-3 fs-4">${medal}</div><div class="flex-grow-1 fw-bold">${name}</div><div class="fw-800 text-warning">${pointsMap[name]} pts</div></div>`;
    });

    // â”€â”€â”€â”€â”€â”€ TAB LOGS â”€â”€â”€â”€â”€â”€
    const filteredLogs = Object.entries(globalOrders)
        .filter(([_, o]) => o.status === 'Sukses' && o.finish_date === selectedDate)
        .sort((a,b) => (b[1].finish_time || '').localeCompare(a[1].finish_time || ''));

    if (filteredLogs.length === 0) {
        logContainer.innerHTML = '<div class="text-center p-5 opacity-25">Tidak ada pengantaran selesai hari ini.</div>';
    } else {
        filteredLogs.forEach(([id, o]) => {
            let menuSummary = '';
            if (o.items?.length) {
                menuSummary = o.items.map(item => {
                    const nama = item.n || item.name || item.nama || 'Menu';
                    const qty = item.qty || 1;
                    const harga = item.p || item.harga || item.price || 0;
                    return `${qty}Ã— ${nama} (Rp ${harga.toLocaleString('id-ID')})`;
                }).join('<br>');
            }

            logContainer.innerHTML += `
                <div class="order-card modern-item mb-3" style="border-left: 5px solid #25D366;">
                    <div class="p-3 w-100">
                        <div class="d-flex justify-content-between align-items-start gap-3">
                            <div style="flex: 1;">
                                <h6 class="fw-bold mb-1">${o.pelanggan || 'PELANGGAN'}</h6>
                                <div class="small text-white-50">${menuSummary || 'Tidak ada detail menu'}</div>
                            </div>
                            <div class="text-end" style="min-width: 140px;">
                                <div class="fw-bold text-info">Rp ${o.total_bayar?.toLocaleString('id-ID')}</div>
                                <div class="small mt-1">
                                    <strong>${o.driver_name || '?'}</strong><br>
                                    <span class="badge bg-success mt-1">SUKSES</span>
                                </div>
                                <div class="text-white-50 mt-1" style="font-size:0.75rem">${o.finish_time || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    }
};

// Auto Login Check
const savedPin = localStorage.getItem('macca_driver_logged_in');
if (savedPin && DRIVER_DB[savedPin]) {
    currentDriver = DRIVER_DB[savedPin];
    document.getElementById('driver-name-display').innerText = currentDriver;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-app').classList.remove('d-none');
    startListening();
}
</script>
</body>
</html>
